define(["jquery","core/ajax","core/notification"],function(a,b,c){var d=d||{};return d.interactions=[],d.singleChoiceInteractions=[],d.subIds=[],d.questionSetPassPercentage=[],d.maxScore=0,d.score=0,d.percentage=0,d.xAPIAnsweredListener=function(a){var b=a.getVerifiedStatementValue(["object","definition","extensions","http://h5p.org/x-api/h5p-local-content-id"]),c=!1;if("Activity"==a.data.statement.object.objectType&&(c=!0),c&&"answered"===a.getVerb()&&"undefined"==typeof d.questionSetPassPercentage[b]&&"undefined"==typeof d.singleChoiceInteractions[b]){var e=a.getScore(),f=a.getMaxScore(),g=a.data.statement.object.id;if(g=g.split("subContentId="),g=g[1],d.subIds.indexOf(g)!=-1){"undefined"==typeof d.interactions[b]&&(d.interactions[b]=1),d.score+=e,d.maxScore+=f;var h=d.interactions[b];d.percentage=d.percentage+d.score/d.maxScore/h*100,d.setResult(b,d.percentage,100)}else if(d.subIds.indexOf(g)==-1&&0==d.subIds.length){var i=e/f*100;d.setResult(b,i,100)}}if("undefined"!=typeof d.questionSetPassPercentage[b]&&"completed"===a.getVerb()){var e=a.getScore(),f=a.getMaxScore(),i=e/f*100,j=d.questionSetPassPercentage[b];i>=j&&d.setResult(b,100,100)}if("undefined"!=typeof d.singleChoiceInteractions[b]&&"completed"===a.getVerb()){var e=a.getScore(),f=a.getMaxScore(),i=e/f*100;d.setResult(b,i,100)}},d.setResult=function(d,e,f){var g=b.call([{methodname:"local_ildhvp_setgrade",args:{contentid:d,score:e,maxscore:f}}]);g[0].done(function(b){var c=String("oc-progress-"+b.sectionid),d=String("oc-progress-text-"+b.sectionid),e=Math.round(b.percentage);e=String(e+"%"),a("#"+c,window.parent.document).css("width",e),a("#"+d,window.parent.document).html(e)}).fail(function(a){c.ex})},d.getVideoInteractions=function(b,c){var e=c.interactiveVideo.assets.interactions,f=c.interactiveVideo.summary.task.params.summaries,g=["H5P.Text","H5P.Table","H5P.Link","H5P.Image","H5P.GoToQuestion","H5P.Nil","H5P.IVHotspot"],h=0,i=0;"object"==typeof e&&(a.each(e,function(b){var c=e[b].action.library,f=e[b].action.subContentId,i=!1;a.each(g,function(a){c.indexOf(g[a])>-1&&(i=!0)}),i||(h++,d.subIds.push(f))}),d.interactions[b]=h),("undefined"==typeof e||"object"==typeof e&&0==h)&&(a(".h5p-iframe")[0].contentWindow.onload=function(){a(".h5p-iframe")[0].contentWindow.H5P.instances[0].video.on("stateChange",function(a){0===a.data&&d.setResult(b,100,100)})}),f.length&&(a.each(f,function(a){if("undefined"!=typeof f[a].summary){var b=c.interactiveVideo.summary.task.subContentId;i++,d.subIds.push(b)}}),d.interactions[b]=h+i)},d.getSingleChoiceInteractions=function(b,c){var e=c.choices;a.each(e,function(a){var b=e[a].subContentId;d.subIds.push(b)}),d.singleChoiceInteractions[b]=e.length},d.getQuestionSetPercentage=function(a,b){d.questionSetPassPercentage[a]=b.passPercentage},d.checkLibrary=function(){var b=a(".h5p-iframe.h5p-initialized").data("content-id");if("undefined"!=typeof b){var c=H5PIntegration.contents["cid-"+b],e=JSON.parse(c.jsonContent),f=c.library;f.indexOf("H5P.InteractiveVideo")>-1?d.getVideoInteractions(b,e):f.indexOf("H5P.QuestionSet")>-1?d.getQuestionSetPercentage(b,e):f.indexOf("H5P.SingleChoiceSet")>-1&&d.getSingleChoiceInteractions(b,e)}},{init:function(){d.checkLibrary(),H5P.externalDispatcher.on("xAPI",d.xAPIAnsweredListener)}}});